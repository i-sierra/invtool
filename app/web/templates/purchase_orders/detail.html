{% extends "base.html" %} {% block content %}
<h2>{{ po.code }} <small>— {{ po.status }}</small></h2>
<div class="grid">
    <div><strong>Distributor:</strong> {{ po.distributor.code }} — {{ po.distributor.name }}</div>
    <div><strong>Currency:</strong> {{ po.currency }}</div>
    <div><strong>Created:</strong> {{ po.created_at }}</div>
</div>

<h3>Lines</h3>
<table>
    <thead>
        <tr>
            <th>IPN</th>
            <th>Ordered</th>
            <th>Received</th>
            <th>Outstanding</th>
            <th>Unit price</th>
            <th>Default loc</th>
            <th>Receive</th>
        </tr>
    </thead>
    <tbody>
        {% for ln in po.lines %}
        <tr>
            <td>{{ ln.part.ipn }}</td>
            <td>{{ ln.ordered_qty }}</td>
            <td>{{ ln.received_qty }}</td>
            <td>{{ ln.ordered_qty - ln.received_qty }}</td>
            <td>{{ ln.unit_price or '-' }}</td>
            <td>{{ ln.default_location.code if ln.default_location else '-' }}</td>
            <td>
                {% if po.status in ['open','draft'] and (ln.ordered_qty - ln.received_qty) > 0 %}
                <form
                    method="post"
                    action="/ui/po/{{ po.id }}/lines/{{ ln.id }}/receive"
                    class="inline"
                    enctype="multipart/form-data">
                    <input
                        name="qty"
                        type="number"
                        step="0.000001"
                        min="0.000001"
                        max="{{ ln.ordered_qty - ln.received_qty }}"
                        placeholder="Qty"
                        required />
                    <select name="location_code">
                        <option value="">—</option>
                        {% for l in locs %}
                        <option
                            value="{{ l.code }}"
                            {%
                            if
                            ln.default_location
                            and
                            ln.default_location.id=="l.id"
                            %}selected{%
                            endif
                            %}>
                            {{ l.code }}
                        </option>
                        {% endfor %}
                    </select>
                    <input name="note" placeholder="Optional note" />
                    <input type="file" name="document" accept=".pdf,image/*" />
                    <button type="submit">Receive</button>
                </form>
                {% else %}—{% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7">No lines.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h3>Add line</h3>
<form method="post" action="/ui/po/{{ po.id }}/lines/new" class="grid">
    <label
        >Part
        <select name="part_id" required>
            {% for p in parts %}
            <option value="{{ p.id }}">{{ p.ipn }} — {{ p.description }}</option>
            {% endfor %}
        </select>
    </label>
    <label
        >Ordered qty
        <input name="ordered_qty" type="number" step="0.000001" min="0.000001" required />
    </label>
    <label
        >Unit price
        <input name="unit_price" type="number" step="0.000001" min="0" />
    </label>
    <label
        >Default location
        <select name="default_location_id">
            <option value="">—</option>
            {% for l in locs %}
            <option value="{{ l.id }}">{{ l.code }}</option>
            {% endfor %}
        </select>
    </label>
    <label
        >Distributor PN
        <input name="distributor_pn" />
    </label>
    <label
        >Note
        <input name="note" />
    </label>
    <div class="actions">
        <button type="submit">Add</button>
        <a class="btn" href="/ui/po">Back</a>
    </div>
</form>

{% if po.status != 'closed' %}
<form method="post" action="/ui/po/{{ po.id }}/cancel" style="margin-top:12px">
    <button type="submit">Cancel PO</button>
</form>
{% endif %} {% endblock %}
